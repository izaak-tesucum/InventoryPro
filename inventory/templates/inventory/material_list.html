{% extends "inventory/base.html" %}
{% block content %}
{% load custom_filters %}

<div class="card shadow-sm border-0 rounded-3">
  <div class="card-body">
    <div class="d-flex justify-content-between align-items-center mb-3">
      <h5 class="card-title mb-0">Inventory List</h5>
    </div>

    <div class="table-responsive">
      <table id="materials-table" class="table align-middle table-hover table-borderless">
        <thead class="bg-light">
          <tr>
            <th>SKU</th>
            <th>Name</th>
            <th>Category</th>
            <th>Quantity</th>
            <th>Unit Cost</th>
            <th>Supplier</th>
            <th>Status</th>
            <th class="text-end">Action</th>
          </tr>
        </thead>
        <tbody>
          {% for m in materials %}
          <tr id="material-{{ m.id }}">
            <td class="fw-semibold text-dark">{{ m.sku }}</td>
            <td>{{ m.name }}</td>
            <td><span class="badge rounded-pill bg-primary-subtle text-dark"><i class="bi bi-tag"></i> {{ m.category }}</span></td>
            <td class="qty-cell">
                <input
                    class="form-control form-control-sm qty-input {% if m.is_low_stock %}text-danger{% else %}text-success{% endif %}"
                    type="text"
                    value="{{ m.quantity }}"
                    data-id="{{ m.id }}"
                >
            </td>
            <td>${{ m.unit_cost }}</td>
            <td>{{ m.supplier }}</td>
            <td>
              {% if m.is_low_stock %}
                <span class="badge rounded-pill bg-danger"><i class="bi bi-exclamation-circle"></i> Safety Stock</span>
              {% else %}
                <span class="badge rounded-pill bg-success"><i class="bi bi-check-circle"></i> On Hand</span>
              {% endif %}
            </td>
            <td class="text-end">
              <div class="btn-group">
                {% if m.is_low_stock %}
                <button class="btn btn-sm btn-outline-primary"><i class="bi bi-cart-plus"></i></button>
                {% endif %}
                <a href="{% url 'material_update' m.id %}" class="btn btn-sm btn-outline-secondary">
                    <i class="bi bi-pencil"></i>
                </a>
                <button class="btn btn-sm btn-outline-danger delete-btn" data-url="{% url 'material_delete' m.id %}"><i class="bi bi-trash"></i></button>
              </div>
            </td>
          </tr>
          {% empty %}
          <tr>
            <td colspan="8" class="text-center text-muted">No materials available</td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>
</div>



<script>
    $(document).ready(function () {
        var table = $('#materials-table').DataTable({
            paging: true,
            searching: true,
            ordering: true,
            pageLength: 10
        });


        //delete material
        $('.delete-btn').click(function() {
            if (!confirm('Are you sure you want to delete this material?')) return;

            var button = $(this);
            var url = button.data('url');

            $.ajax({
                url: url,
                type: 'POST',
                data: {
                    csrfmiddlewaretoken: '{{ csrf_token }}'
                },
                success: function(response) {
                    if (response.success) {
                        // Remove row from DataTable dynamically
                        var row = button.closest('tr');
                        table.row(row).remove().draw(false);
                    } else {
                        alert("Error: " + (response.error || "Failed to delete material."));
                    }
                },
                error: function (xhr, status, error) {
                    alert("Request failed: " + error);
                }
            });
        });

        //update stock quantity
        $(".qty-input").change(function () {
            let materialId = $(this).data("id");
            let newQty = $(this).val();

            $.ajax({
                url: `/invmgmt/materials/${materialId}/update_stock/`,
                method: "POST",
                data: {
                    quantity: newQty,
                    csrfmiddlewaretoken: '{{ csrf_token }}'
                },
                success: function (response) {
                    if (response.success) {
                        location.reload();

                        // optional
                        // $(`#material-${materialId} .qty-cell`).text(newQty);
                    } else {
                        alert("Error: " + (response.error || "Could not update stock."));
                    }
                },
                error: function (xhr, status, error) {
                    alert("Request failed: " + error);
                }
            });
        });
    });
</script>
{% endblock %}